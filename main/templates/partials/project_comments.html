<div class="comments-panel">
  <header class="comments-panel__header">
    <h2>Comments for {{ project.title }}</h2>
  </header>

  {# COMMENT FORM #}
  {% if form %}
    <form method="post"
          action="{% url 'comment_create' id=project.id %}"
          class="comments-form">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <div class="comments-form__field">
        {{ form.content.errors }}
        {{ form.content }}
      </div>

      <div class="comments-form__actions">
        <button type="submit" class="comments-btn-primary">
          Post comment
        </button>
      </div>
    </form>
  {% else %}
    <p class="comments-signin-note">
      You need to be signed in to leave a comment.
    </p>
  {% endif %}

  {# SCROLLABLE COMMENTS LIST #}
  <div class="comments-scroll">
    {% if comments %}
      {% for c in comments %}
        <article class="comment-card">
          <header class="comment-card__meta">
            <span class="comment-card__author">
              {{ c.user.username|default:c.author_name|default:"Anon" }}
            </span>

            <div class="comment-card__meta-right">
              <time class="comment-card__date" datetime="{{ c.created_at|date:'c' }}">
                {{ c.created_at|date:"Y-m-d H:i" }}
              </time>

              {# Delete button for owner #}
              {% if request.user.is_authenticated and c.user_id == request.user.id %}
                <form method="post"
                      action="{% url 'comment_delete' id=project.id comment_id=c.id %}"
                      class="comment-delete-form">
                  {% csrf_token %}
                  <button type="submit" class="comment-delete-btn">Delete</button>
                </form>
              {% elif not c.user_id and request.session.user_email %}
                {% with session_name=request.session.user_name
                        session_author=request.session.author_name
                        session_email=request.session.user_email %}
                  {% if c.author_name == session_name or c.author_name == session_author or c.author_name == session_email %}
                    <form method="post"
                          action="{% url 'comment_delete' id=project.id comment_id=c.id %}"
                          class="comment-delete-form">
                      {% csrf_token %}
                      <button type="submit" class="comment-delete-btn">Delete</button>
                    </form>
                  {% endif %}
                {% endwith %}
              {% endif %}
            </div>
          </header>

          <p class="comment-card__body">
            {{ c.content }}
          </p>
        </article>
      {% endfor %}
    {% else %}
      <p class="comments-empty">No comments yet. Be the first!</p>
    {% endif %}
  </div>
</div>
