{% if show_comments_title %}
  <header class="comments-panel__header">
    <h2>Comments for {{ project.title }}</h2>
  </header>
{% endif %}

{# ---------- COMMENT FORM ---------- #}
{% if form %}
  <form
    method="post"
    action="{% url 'comment_create' id=project.id %}"
    class="comments-form">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div class="comments-form__field">
      {{ form.content.errors }}
      {{ form.content }}
    </div>

    <div class="comments-form__actions">
      <button type="submit" class="comments-btn-primary">
        Post comment
      </button>
    </div>
  </form>
{% else %}
  <p class="comments-signin-note">
    You need to be signed in to leave a comment.
  </p>
{% endif %}

{# ---------- SCROLLABLE COMMENTS LIST ---------- #}
<div class="comments-scroll">
  {% for c in comments %}
    {% with
      session_name=request.session.user_name
      session_email=request.session.user_email
    %}
      <article class="comment-card">
        <header class="comment-card__meta">
          <span class="comment-card__author">
            {{ c.user.username|default:c.author_name|default:"Anon" }}
          </span>

          <div class="comment-card__meta-right">
            <time
              class="comment-card__date"
              datetime="{{ c.created_at|date:'c' }}">
              {{ c.created_at|date:"Y-m-d H:i" }}
            </time>

            {# ---------- PERMISSION GATE ---------- #}
            {% if request.user.is_authenticated and request.user.is_staff %}
              {% include "partials/comment_controls.html" with project=project c=c %}
            {% elif c.user and request.user.is_authenticated and request.user == c.user %}
              {% include "partials/comment_controls.html" with project=project c=c %}
            {% elif not c.user and c.author_name and session_name == c.author_name %}
              {% include "partials/comment_controls.html" with project=project c=c %}
            {% elif not c.user and c.author_email and session_email == c.author_email %}
              {% include "partials/comment_controls.html" with project=project c=c %}
            {% endif %}
          </div>
        </header>

        <p class="comment-card__body">
          {{ c.content }}
        </p>
      </article>
    {% endwith %}
  {% empty %}
    <p class="comments-empty">No comments yet. Be the first!</p>
  {% endfor %}
</div>
